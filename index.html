<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AES-GCM V8 (åŸåéš±å½¢ç‰ˆ)</title>
    <style>
        :root {
            --bg: #0f0f10; --card: #18181b; --text: #e4e4e7;
            --accent: #6366f1; --err: #ef4444; --ok: #22c55e;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg); color: var(--text);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; padding: 20px;
        }
        h1 { font-weight: 300; letter-spacing: 1px; margin-bottom: 5px; }
        .warning-box {
            background: rgba(239, 68, 68, 0.1); border: 1px solid var(--err);
            color: var(--err); padding: 10px 15px; border-radius: 8px;
            font-size: 0.9rem; margin-bottom: 20px; max-width: 600px; text-align: center;
        }

        .container { display: flex; gap: 20px; width: 100%; max-width: 800px; flex-wrap: wrap; }
        
        .drop-zone {
            flex: 1; min-width: 300px; background: var(--card); padding: 40px 20px;
            border-radius: 12px; border: 2px dashed #3f3f46; text-align: center;
            cursor: pointer; transition: 0.2s; position: relative;
        }
        .drop-zone:hover { border-color: var(--accent); background: #27272a; transform: translateY(-2px); }
        
        .icon { font-size: 2.5rem; margin-bottom: 15px; display: block; }
        h2 { margin: 5px 0; font-size: 1.2rem; }
        p { color: #a1a1aa; font-size: 0.85rem; }

        .input-group { width: 100%; max-width: 800px; margin-bottom: 20px; }
        input[type="password"] {
            width: 100%; padding: 15px; background: var(--card); border: 1px solid #3f3f46;
            color: #fff; border-radius: 12px; text-align: center; font-size: 1.1rem;
            box-sizing: border-box; transition: 0.3s;
        }
        input[type="password"]:focus { border-color: var(--accent); outline: none; }

        #progress-bar { width: 100%; max-width: 800px; height: 4px; background: #27272a; margin-top: 20px; border-radius: 2px; overflow: hidden; display: none; }
        #progress-fill { height: 100%; width: 0%; background: var(--accent); transition: width 0.1s; }

        #log-area {
            width: 100%; max-width: 800px; margin-top: 15px; font-family: monospace;
            font-size: 0.85rem; color: #71717a; max-height: 150px; overflow-y: auto;
        }
        .log-err { color: var(--err); } .log-ok { color: var(--ok); }

        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <h1>FILE VAULT <span style="font-size:0.5em; vertical-align:middle; background:#333; padding:2px 6px; border-radius:4px;">V8</span></h1>
    
    <div class="warning-box">
        âš ï¸ <strong>é‡è¦æç¤ºï¼š</strong> è¼¸å‡ºæª”åå°‡èˆ‡åŸæª”åç›¸åŒã€‚<br>
        å­˜æª”æ™‚è«‹å‹™å¿…é¸æ“‡<strong>ã€Œä¸åŒçš„è³‡æ–™å¤¾ã€</strong>ï¼Œåˆ‡å‹¿ç›´æ¥è¦†è“‹æ­£åœ¨è®€å–çš„åŸæª”ï¼
    </div>

    <div class="input-group">
        <input type="password" id="password" placeholder="è«‹è¨­å®šå¯†ç¢¼" autocomplete="off">
    </div>

    <div class="container">
        <div class="drop-zone" id="drop-enc">
            <span class="icon">ğŸ”’</span>
            <h2>åŠ å¯† (Encrypt)</h2>
            <p>è¼¸å‡ºæª”åä¿æŒä¸è®Š</p>
            <input type="file" id="file-enc" multiple>
        </div>

        <div class="drop-zone" id="drop-dec">
            <span class="icon">ğŸ”“</span>
            <h2>è§£å¯† (Decrypt)</h2>
            <p>è‡ªå‹•é©—è­‰ä¸¦é‚„åŸ</p>
            <input type="file" id="file-dec" multiple>
        </div>
    </div>

    <div id="progress-bar"><div id="progress-fill"></div></div>
    <div id="log-area"><div>> ç³»çµ±å°±ç·’ (è«‹ä½¿ç”¨ Chrome/Edge)</div></div>

<script>
    // --- V8 é…ç½® ---
    const CONFIG = {
        CHUNK: 1024 * 1024 * 16, // 16MB åˆ†å¡Š
        ITERATIONS: 100000,
        SALT_LEN: 32,
        IV_LEN: 12,
        SIG: new Uint8Array([0x47, 0x45, 0x4D, 0x5F, 0x56, 0x38]) // "GEM_V8"
    };

    // --- å·¥å…· ---
    const ui = {
        log: (msg, type='') => {
            const el = document.getElementById('log-area');
            el.innerHTML = `<div class="log-${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>` + el.innerHTML;
        },
        progress: (pct) => {
            const bar = document.getElementById('progress-bar');
            bar.style.display = pct >= 0 ? 'block' : 'none';
            document.getElementById('progress-fill').style.width = pct + '%';
        }
    };

    if (!window.showSaveFilePicker) alert("è«‹ä½¿ç”¨ Chrome æˆ– Edge ç€è¦½å™¨ã€‚");

    // --- Crypto ---
    async function deriveKey(pwd, salt) {
        const enc = new TextEncoder();
        const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(pwd), {name: "PBKDF2"}, false, ["deriveKey"]);
        return crypto.subtle.deriveKey(
            { name: "PBKDF2", salt: salt, iterations: CONFIG.ITERATIONS, hash: "SHA-256" },
            keyMaterial, { name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]
        );
    }

    function readSlice(file, start, end) {
        return new Promise((resolve, reject) => {
            const r = new FileReader();
            r.onload = () => resolve(r.result);
            r.onerror = reject;
            r.readAsArrayBuffer(file.slice(start, end));
        });
    }

    // --- åŠ å¯†æµç¨‹ ---
    async function processEncrypt(file) {
        const pwd = document.getElementById('password').value;
        if (!pwd) return ui.log("å¯†ç¢¼ä¸èƒ½ç‚ºç©º", "err");

        try {
            // æª¢æŸ¥æ˜¯å¦é‡è¤‡åŠ å¯†
            const checkSig = new Uint8Array(await readSlice(file, 0, CONFIG.SIG.length));
            if (checkSig.every((v, i) => v === CONFIG.SIG[i])) {
                if(!confirm(`æª”æ¡ˆ ${file.name} ä¼¼ä¹å·²åŠ å¯†ã€‚ç¹¼çºŒåŠ å¯†å°‡å°è‡´é›™é‡é–å®šã€‚ç¢ºå®šå—ï¼Ÿ`)) return;
            }

            // [é—œéµä¿®æ”¹] å»ºè­°æª”å = åŸæª”å
            const handle = await window.showSaveFilePicker({ suggestedName: file.name });
            const writable = await handle.createWritable();

            ui.log(`åŠ å¯†é–‹å§‹: ${file.name}`, "info");
            ui.progress(0);

            // å¯«å…¥æª”é ­
            await writable.write(CONFIG.SIG);
            const salt = crypto.getRandomValues(new Uint8Array(CONFIG.SALT_LEN));
            await writable.write(salt);

            const key = await deriveKey(pwd, salt);
            let offset = 0;
            const total = file.size;

            while (offset < total) {
                const chunk = await readSlice(file, offset, offset + CONFIG.CHUNK);
                offset += chunk.byteLength;

                const iv = crypto.getRandomValues(new Uint8Array(CONFIG.IV_LEN));
                const encrypted = await crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, chunk);

                await writable.write(iv);
                const lenBuf = new ArrayBuffer(4);
                new DataView(lenBuf).setUint32(0, encrypted.byteLength, true);
                await writable.write(lenBuf);
                await writable.write(encrypted);

                ui.progress((offset / total) * 100);
            }

            await writable.close();
            ui.log(`âœ… åŠ å¯†æˆåŠŸ (å·²å­˜ç‚º ${handle.name})`, "ok");
            ui.progress(-1);

        } catch (e) {
            console.error(e);
            ui.log(`âŒ å¤±æ•—: ${e.message}`, "err");
            ui.progress(-1);
        }
    }

    // --- è§£å¯†æµç¨‹ ---
    async function processDecrypt(file) {
        const pwd = document.getElementById('password').value;
        if (!pwd) return ui.log("å¯†ç¢¼ä¸èƒ½ç‚ºç©º", "err");

        try {
            // é©—è­‰ç°½å
            const sigLen = CONFIG.SIG.length;
            const fileSig = new Uint8Array(await readSlice(file, 0, sigLen));
            if (!fileSig.every((v, i) => v === CONFIG.SIG[i])) throw new Error("é€™ä¸æ˜¯æœ¬å·¥å…·åŠ å¯†çš„æª”æ¡ˆ");

            // è®€ Salt
            let offset = sigLen;
            const salt = new Uint8Array(await readSlice(file, offset, offset + CONFIG.SALT_LEN));
            offset += CONFIG.SALT_LEN;

            const key = await deriveKey(pwd, salt);

            // å¯†ç¢¼é æª¢ (è©¦è§£ç¬¬ä¸€å¡Š)
            ui.log("æ­£åœ¨é©—è­‰å¯†ç¢¼...", "info");
            const hSize = CONFIG.IV_LEN + 4;
            const head = await readSlice(file, offset, offset + hSize);
            const iv0 = new Uint8Array(head.slice(0, CONFIG.IV_LEN));
            const len0 = new DataView(head.slice(CONFIG.IV_LEN)).getUint32(0, true);
            const data0 = await readSlice(file, offset + hSize, offset + hSize + len0);
            
            try {
                await crypto.subtle.decrypt({ name: "AES-GCM", iv: iv0 }, key, data0);
            } catch { throw new Error("å¯†ç¢¼éŒ¯èª¤"); }

            // [é—œéµä¿®æ”¹] å»ºè­°æª”å = åŸæª”å (ä¸åŠ å‰ç¶´å¾Œç¶´)
            const handle = await window.showSaveFilePicker({ suggestedName: file.name });
            const writable = await handle.createWritable();

            ui.log(`è§£å¯†é–‹å§‹: ${file.name}`, "info");
            ui.progress(0);

            const total = file.size;
            while (offset < total) {
                const iv = new Uint8Array(await readSlice(file, offset, offset + CONFIG.IV_LEN));
                offset += CONFIG.IV_LEN;
                
                const lenBuf = await readSlice(file, offset, offset + 4);
                const len = new DataView(lenBuf).getUint32(0, true);
                offset += 4;

                const data = await readSlice(file, offset, offset + len);
                offset += len;

                const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, key, data);
                await writable.write(decrypted);

                ui.progress((offset / total) * 100);
            }

            await writable.close();
            ui.log(`âœ… è§£å¯†æˆåŠŸ (å·²å­˜ç‚º ${handle.name})`, "ok");
            ui.progress(-1);

        } catch (e) {
            console.error(e);
            ui.log(`âŒ å¤±æ•—: ${e.message}`, "err");
            ui.progress(-1);
        }
    }

    // --- Events ---
    function setup(id, fn) {
        const el = document.getElementById(id);
        const inp = el.querySelector('input');
        el.onclick = () => inp.click();
        inp.onchange = (e) => {
            Array.from(e.target.files).forEach(f => fn(f));
            inp.value='';
        };
        el.ondragover = e => e.preventDefault();
        el.ondrop = e => {
            e.preventDefault();
            Array.from(e.dataTransfer.files).forEach(f => fn(f));
        };
    }
    setup('drop-enc', processEncrypt);
    setup('drop-dec', processDecrypt);

</script>
</body>
</html>
